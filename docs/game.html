<!DOCTYPE html>  <html> <head>   <title>game.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="animation.html">                 animation.coffee               </a>                                           <a class="source" href="cider.html">                 cider.coffee               </a>                                           <a class="source" href="clock.html">                 clock.coffee               </a>                                           <a class="source" href="entity.html">                 entity.coffee               </a>                                           <a class="source" href="game.html">                 game.coffee               </a>                                           <a class="source" href="gamecontroller.html">                 gamecontroller.coffee               </a>                                           <a class="source" href="init.html">                 init.coffee               </a>                                           <a class="source" href="level.html">                 level.coffee               </a>                                           <a class="source" href="levelLoader.html">                 levelLoader.coffee               </a>                                           <a class="source" href="loader.html">                 loader.coffee               </a>                                           <a class="source" href="map.html">                 map.coffee               </a>                                           <a class="source" href="modernizr.html">                 modernizr.coffee               </a>                                           <a class="source" href="platformerEntity.html">                 platformerEntity.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               game.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Cider's main game class; lives at <code>c.Game</code>. Example usage:</p>

<pre><code>class myGame extends c.Game
    constructor: -&gt;
         super

         someLevel = new c.Level this
         @loadLevel someLevel

         for i in [0..10]
              new MyEntity this

new myGame
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Game</span>
  <span class="nv">constructor: </span><span class="nf">(options = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>_entityIdCounter is used to generate entityIds, which are used for things like notifying entities of collisions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@_entityIdCounter = </span><span class="mi">1</span>

    <span class="vi">@clock = </span><span class="k">new</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Clock</span>

    <span class="vi">@levelLoader = </span><span class="k">new</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LevelLoader</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><code>Object</code> containing all <code>Entity</code> objects associated with this game. Usually you'll probably want to use methods like <code>@game.getEntityById()</code> and <code>@game.getEntitiesByClassName()</code> instead of accessing this directly, but you may come across a situation where it's handy.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@entities = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>Object</code> containing all resources (images, sound files, etc) needed for this game. Used inside other classes like this: <code>@game.resources['hero sprite']</code>, as well as for preloading all necessary files on page load. For images, values should be a string. For sounds, values should be an array of strings.</p>

<pre><code>@resources =
    'hero sprite': '/img/sprites/hero.png'
    'ominous boss music': ['/audio/boss.mp3', '/audio/boss.ogg']
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@resources = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">@resources</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Camera size in CSS pixels. This is the viewport into the game world.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@cSize = </span><span class="p">{</span><span class="nv">x: </span><span class="mi">640</span><span class="p">,</span> <span class="nv">y: </span><span class="mi">320</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Tag name, classes, and ID for this game's camera element, probably only useful for styling and such, if you need to do that.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@tagName = </span><span class="s">&#39;div&#39;</span>
    <span class="vi">@className = </span><span class="s">&#39;&#39;</span>
    <span class="vi">@id = </span><span class="s">&#39;cider-camera&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Other default properties. Gravity defaults to <code>{x:0, y:9.8}</code> (Earth gravity), and cPos gets reset to <code>{x: 0, y: 0}</code> every time <code>@game.loadLevel()</code> is called.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@gravity = </span><span class="p">{</span><span class="nv">x: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">y: </span><span class="mf">9.8</span><span class="p">}</span>
    <span class="vi">@cPos = </span><span class="p">{</span><span class="nv">x: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">y: </span><span class="mi">0</span><span class="p">}</span>
    <span class="vi">@debug = </span><span class="kc">false</span>
    <span class="vi">@debugDraw = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Overwrite defaults with any passed options.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">c</span><span class="p">.</span><span class="nx">extend</span> <span class="k">this</span><span class="p">,</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>bodyTrash</code> is just a queue to remember which entities have died, since we can't remove them from the physics simulation during its <code>Step</code> phase.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@bodyTrash = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Set up the DOM elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@createElements</span><span class="p">()</span>
    <span class="nx">@initializeElements</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Now that our DOM stuff is set up, create a new <code>GameController</code> for this game.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@controller = </span><span class="k">new</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GameController</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Set up a loader.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@loader = </span><span class="k">new</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Loader</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@resources</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>If this game is in debug mode, display FPS and other debug data.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@debug</span>
      <span class="nx">@initializeDebugMode</span><span class="p">()</span>
      <span class="vi">@lastFrameStart = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Create canvas for debugDraw, if applicable.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@debugDraw</span>
      <span class="vi">@debugCanvas = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&#39;canvas&#39;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">@debugCanvas</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Kick off our run loop.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@run</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This only gets called if the constructor passed <code>debug: true</code>. All it does is set up a container for FPS (and eventually other data).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initializeDebugMode: </span><span class="o">=&gt;</span>
    <span class="vi">@debugEl = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&#39;div&#39;</span>

    <span class="nv">style = </span><span class="nx">@debugEl</span><span class="p">.</span><span class="nx">style</span>

    <span class="vi">@debugEl.id = </span><span class="s">&#39;cider-debug&#39;</span>

    <span class="nv">style.position = </span><span class="s">&#39;absolute&#39;</span>
    <span class="nv">style.bottom = </span><span class="s">&#39;0px&#39;</span>
    <span class="nv">style.right = </span><span class="s">&#39;0px&#39;</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">@debugEl</span>

  <span class="nv">initializeCollisionListeners: </span><span class="o">=&gt;</span>
    <span class="nv">listener = </span><span class="k">new</span> <span class="nx">b2ContactListener</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>BeginContact/EndContact are used internally by <code>PlatformerEntity</code> to determine if it's currently standing.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">listener.BeginContact = </span><span class="p">(</span><span class="nx">contact</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">eA = </span><span class="nx">@entities</span><span class="p">[</span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetFixtureA</span><span class="p">().</span><span class="nx">GetBody</span><span class="p">().</span><span class="nx">GetUserData</span><span class="p">()]</span>
      <span class="nv">eB = </span><span class="nx">@entities</span><span class="p">[</span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetFixtureB</span><span class="p">().</span><span class="nx">GetBody</span><span class="p">().</span><span class="nx">GetUserData</span><span class="p">()]</span>

      <span class="nx">eA</span><span class="p">.</span><span class="nx">contactBegin</span><span class="p">(</span><span class="nx">contact</span><span class="p">)</span> <span class="k">if</span> <span class="nx">eA</span>
      <span class="nx">eB</span><span class="p">.</span><span class="nx">contactBegin</span><span class="p">(</span><span class="nx">contact</span><span class="p">)</span> <span class="k">if</span> <span class="nx">eB</span>

    <span class="nv">listener.EndContact = </span><span class="p">(</span><span class="nx">contact</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">eA = </span><span class="nx">@entities</span><span class="p">[</span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetFixtureA</span><span class="p">().</span><span class="nx">GetBody</span><span class="p">().</span><span class="nx">GetUserData</span><span class="p">()]</span>
      <span class="nv">eB = </span><span class="nx">@entities</span><span class="p">[</span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetFixtureB</span><span class="p">().</span><span class="nx">GetBody</span><span class="p">().</span><span class="nx">GetUserData</span><span class="p">()]</span>

      <span class="nx">eA</span><span class="p">.</span><span class="nx">contactEnd</span><span class="p">(</span><span class="nx">contact</span><span class="p">)</span> <span class="k">if</span> <span class="nx">eA</span>
      <span class="nx">eB</span><span class="p">.</span><span class="nx">contactEnd</span><span class="p">(</span><span class="nx">contact</span><span class="p">)</span> <span class="k">if</span> <span class="nx">eB</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><code>PreSolve</code> is useful for preventing collisions with the collision map (one-way platforms, etc).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">listener.PreSolve = </span><span class="p">(</span><span class="nx">contact</span><span class="p">,</span> <span class="nx">oldManifold</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This would cancel the collision, allowing the entities to pass through each other
   if someLogic
        contact.SetEnabled false</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">listener.PostSolve = </span><span class="p">(</span><span class="nx">contact</span><span class="p">,</span> <span class="nx">impulse</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">eA = </span><span class="nx">@entities</span><span class="p">[</span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetFixtureA</span><span class="p">().</span><span class="nx">GetBody</span><span class="p">().</span><span class="nx">GetUserData</span><span class="p">()]</span>
      <span class="nv">eB = </span><span class="nx">@entities</span><span class="p">[</span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetFixtureB</span><span class="p">().</span><span class="nx">GetBody</span><span class="p">().</span><span class="nx">GetUserData</span><span class="p">()]</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>For now, we only call <code>collidePost</code> on entity collisions. Entity/map collision is handled inside <code>PreSolve</code> (<code>collidePre</code> in the entity class).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">eA</span> <span class="o">&amp;&amp;</span> <span class="nx">eB</span>
        <span class="nx">eA</span><span class="p">.</span><span class="nx">collidePost</span> <span class="nx">eB</span><span class="p">,</span> <span class="nx">impulse</span><span class="p">.</span><span class="nx">normalImpulses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">eB</span><span class="p">.</span><span class="nx">collidePost</span> <span class="nx">eA</span><span class="p">,</span> <span class="nx">impulse</span><span class="p">.</span><span class="nx">normalImpulses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">@world</span><span class="p">.</span><span class="nx">SetContactListener</span> <span class="nx">listener</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set up the camera and game world elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">createElements: </span><span class="o">=&gt;</span>
    <span class="nv">cameraEl = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&#39;div&#39;</span>
    <span class="nv">cameraEl.id = </span><span class="nx">@id</span>
    <span class="nv">cameraEl.className = </span><span class="nx">@className</span>

    <span class="vi">@cameraEl = </span><span class="nx">cameraEl</span>

    <span class="nv">el = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="nx">@tagName</span>
    <span class="nv">el.id = </span><span class="s">&#39;cider-world&#39;</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="s">&#39;tabindex&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span>

    <span class="vi">@el = </span><span class="nx">el</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Does what it says on the tin.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getEntityById: </span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">match = </span><span class="kc">null</span>

    <span class="k">for</span> <span class="nx">eId</span><span class="p">,</span> <span class="nx">entity</span> <span class="k">of</span> <span class="nx">@entities</span>
      <span class="nv">match = </span><span class="nx">entity</span> <span class="k">if</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span>

    <span class="k">return</span> <span class="nx">match</span>

  <span class="nv">initializeElements: </span><span class="o">=&gt;</span>
    <span class="nv">cEs = </span><span class="nx">@cameraEl</span><span class="p">.</span><span class="nx">style</span>
    <span class="nv">cEs.width = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@cSize</span><span class="p">.</span><span class="nx">x</span><span class="si">}</span><span class="s">px&quot;</span>
    <span class="nv">cEs.height = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@cSize</span><span class="p">.</span><span class="nx">y</span><span class="si">}</span><span class="s">px&quot;</span>
    <span class="nv">cEs.overflow = </span><span class="s">&#39;hidden&#39;</span>
    <span class="nv">cEs.position = </span><span class="s">&#39;relative&#39;</span>

    <span class="nv">es = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">style</span>
    <span class="nv">es.overflow = </span><span class="s">&#39;hidden&#39;</span>
    <span class="nv">es.position = </span><span class="s">&#39;absolute&#39;</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">@cameraEl</span>
    <span class="nx">@cameraEl</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">@el</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>This actually repositions the game world and not the camera itself, but has the same effect as moving the camera.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">positionCamera: </span><span class="o">=&gt;</span>
    <span class="nx">unless</span> <span class="nx">@currentLevel</span> <span class="k">then</span> <span class="k">return</span>

    <span class="nv">es = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">style</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Don't allow the camera to go outside level boundries.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@cPos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="vi">@cPos.x = </span><span class="mi">0</span>
    <span class="k">if</span> <span class="nx">@cPos</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">@currentLevel</span><span class="p">.</span><span class="nx">pxSize</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@cSize</span><span class="p">.</span><span class="nx">x</span> <span class="k">then</span> <span class="vi">@cPos.x = </span><span class="nx">@currentLevel</span><span class="p">.</span><span class="nx">pxSize</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@cSize</span><span class="p">.</span><span class="nx">x</span>

    <span class="k">if</span> <span class="nx">@cPos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="vi">@cPos.y = </span><span class="mi">0</span>
    <span class="k">if</span> <span class="nx">@cPos</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">@currentLevel</span><span class="p">.</span><span class="nx">pxSize</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">@cSize</span><span class="p">.</span><span class="nx">y</span> <span class="k">then</span> <span class="vi">@cPos.y = </span><span class="nx">@currentLevel</span><span class="p">.</span><span class="nx">pxSize</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">@cSize</span><span class="p">.</span><span class="nx">y</span>

    <span class="nv">es.left = </span><span class="s">&quot;</span><span class="si">#{</span><span class="o">-</span><span class="nx">@cPos</span><span class="p">.</span><span class="nx">x</span><span class="si">}</span><span class="s">px&quot;</span>
    <span class="nv">es.top = </span><span class="s">&quot;</span><span class="si">#{</span><span class="o">-</span><span class="nx">@cPos</span><span class="p">.</span><span class="nx">y</span><span class="si">}</span><span class="s">px&quot;</span>

    <span class="nv">maps = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">getElementsByClassName</span> <span class="s">&#39;cider-map&#39;</span>
    <span class="k">for</span> <span class="nx">map</span> <span class="k">in</span> <span class="nx">maps</span>
      <span class="nv">distance = </span><span class="nb">parseInt</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;data-distance&#39;</span><span class="p">),</span> <span class="mi">10</span>
      <span class="nx">unless</span> <span class="nx">distance</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="nv">ms = </span><span class="nx">map</span><span class="p">.</span><span class="nx">style</span>
        <span class="nv">ms.left = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@cPos</span><span class="p">.</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">distance</span><span class="si">}</span><span class="s">px&quot;</span>
        <span class="nv">ms.top = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@cPos</span><span class="p">.</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">distance</span><span class="si">}</span><span class="s">px&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Load a new <code>Level</code> object, and reconfigure game settings as appropriate.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">loadLevel: </span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Recreate the world every time we load a level.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@world = </span><span class="k">new</span> <span class="nx">b2World</span><span class="p">(</span><span class="k">new</span> <span class="nx">b2Vec2</span><span class="p">(</span><span class="nx">@gravity</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@gravity</span><span class="p">.</span><span class="nx">y</span><span class="p">),</span> <span class="kc">true</span><span class="p">)</span>
    <span class="vi">@el.innerHTML = </span><span class="s">&#39;&#39;</span>

    <span class="nx">@initializeCollisionListeners</span><span class="p">()</span>
    <span class="vi">@currentLevel = </span><span class="nx">level</span>
    <span class="vi">@cPos = </span><span class="p">{</span><span class="nv">x: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">y: </span><span class="mi">0</span><span class="p">}</span>

    <span class="nv">es = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">style</span>
    <span class="nv">es.width = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">level</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">level</span><span class="p">.</span><span class="nx">tileSize</span><span class="si">}</span><span class="s">px&quot;</span>
    <span class="nv">es.height = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">level</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">level</span><span class="p">.</span><span class="nx">tileSize</span><span class="si">}</span><span class="s">px&quot;</span>

    <span class="k">if</span> <span class="nx">@debugDraw</span>
      <span class="vi">@debugCanvas.width = </span><span class="nx">level</span><span class="p">.</span><span class="nx">pxSize</span><span class="p">.</span><span class="nx">x</span>
      <span class="vi">@debugCanvas.height = </span><span class="nx">level</span><span class="p">.</span><span class="nx">pxSize</span><span class="p">.</span><span class="nx">y</span>

      <span class="nv">debugDraw = </span><span class="k">new</span> <span class="nx">Box2D</span><span class="p">.</span><span class="nx">Dynamics</span><span class="p">.</span><span class="nx">b2DebugDraw</span>
      <span class="nx">debugDraw</span><span class="p">.</span><span class="nx">SetSprite</span> <span class="nx">@debugCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
      <span class="nx">debugDraw</span><span class="p">.</span><span class="nx">SetDrawScale</span> <span class="nx">c</span><span class="p">.</span><span class="nx">b2Scale</span>
      <span class="nx">debugDraw</span><span class="p">.</span><span class="nx">SetFillAlpha</span> <span class="mf">0.3</span>
      <span class="nx">debugDraw</span><span class="p">.</span><span class="nx">SetLineThickness</span> <span class="mi">1</span>
      <span class="nx">debugDraw</span><span class="p">.</span><span class="nx">SetFlags</span> <span class="nx">b2DebugDraw</span><span class="p">.</span><span class="nx">e_shapeBit</span> <span class="o">|</span> <span class="nx">b2DebugDraw</span><span class="p">.</span><span class="nx">e_jointBit</span>
      <span class="nx">@world</span><span class="p">.</span><span class="nx">SetDebugDraw</span> <span class="nx">debugDraw</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Tell our LevelLoader to load this level, which creates all the bodies for collision maps, and the display elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@levelLoader</span><span class="p">.</span><span class="nx">load</span> <span class="nx">level</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Ready gets called once all <code>resources</code> are loaded. Kick off your game here</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ready: </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Pause the game (no entities will be updated during this time).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pause: </span><span class="o">=&gt;</span>
    <span class="vi">@paused = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Unpause the game (entity updates resume).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unpause: </span><span class="o">=&gt;</span>
    <span class="vi">@paused = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The run loop, which updates our global clock, calculates debug information, and most importantly calls <code>update()</code> and <code>draw()</code> for all game entities.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">run: </span><span class="o">=&gt;</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">raf</span> <span class="nx">@run</span>

    <span class="nx">c</span><span class="p">.</span><span class="nx">Clock</span><span class="p">.</span><span class="nx">step</span><span class="p">()</span>
    <span class="vi">@tick = </span><span class="nx">@clock</span><span class="p">.</span><span class="nx">tick</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">@paused</span> <span class="k">then</span> <span class="k">return</span>

    <span class="k">if</span> <span class="nx">@debug</span>
      <span class="vi">@fps = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">((</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">@lastFrameStart</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span>
      <span class="vi">@lastFrameStart = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>

    <span class="nx">@update</span><span class="p">()</span>
    <span class="nx">@draw</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">@debug</span> <span class="o">&amp;&amp;</span> <span class="o">~~</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
      <span class="vi">@debugEl.innerText = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@fps</span><span class="si">}</span><span class="s"> FPS&quot;</span>

  <span class="nv">update: </span><span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@world</span>
      <span class="nx">@world</span><span class="p">.</span><span class="nx">DestroyBody</span> <span class="nx">body</span> <span class="k">for</span> <span class="nx">body</span> <span class="k">in</span> <span class="nx">@bodyTrash</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Move our physics world ahead to match our tick (<code>tick, velocity iterations, position iterations</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@world</span><span class="p">.</span><span class="nx">Step</span> <span class="nx">@tick</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span>
      <span class="nx">@world</span><span class="p">.</span><span class="nx">ClearForces</span><span class="p">()</span>

      <span class="k">if</span> <span class="nx">@debugDraw</span>
        <span class="nx">@world</span><span class="p">.</span><span class="nx">DrawDebugData</span><span class="p">()</span>

    <span class="nx">@updateEntities</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Update the game's camera position</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@positionCamera</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Update the controller to clear out its list of triggered actions (these get reset after every frame).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@controller</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span>

  <span class="nv">draw: </span><span class="o">=&gt;</span>
    <span class="nx">@drawEntities</span><span class="p">()</span>

  <span class="nv">updateEntities: </span><span class="o">=&gt;</span>
    <span class="nx">entity</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span> <span class="k">for</span> <span class="nx">eId</span><span class="p">,</span> <span class="nx">entity</span> <span class="k">of</span> <span class="nx">@entities</span>

  <span class="nv">drawEntities: </span><span class="o">=&gt;</span>
    <span class="nx">entity</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span> <span class="k">for</span> <span class="nx">eId</span><span class="p">,</span> <span class="nx">entity</span> <span class="k">of</span> <span class="nx">@entities</span>

  <span class="nv">createEntity: </span><span class="p">(</span><span class="nx">entity</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">eId = </span><span class="s">&quot;e</span><span class="si">#{</span><span class="nx">@_entityIdCounter</span><span class="o">++</span><span class="si">}</span><span class="s">&quot;</span>

    <span class="nx">@entities</span><span class="p">[</span><span class="nx">eId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entity</span>

    <span class="k">return</span> <span class="nx">eId</span>

  <span class="nv">destroyEntity: </span><span class="p">(</span><span class="nx">entity</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>We can't actually remove the body from the simulation until this <code>Step</code> is finished, so we'll just take care of it at the beginning of the next <code>update</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@bodyTrash</span><span class="p">.</span><span class="nx">push</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">body</span>

    <span class="k">delete</span> <span class="nx">@entities</span><span class="p">[</span><span class="nx">entity</span><span class="p">.</span><span class="nx">_entityId</span><span class="p">]</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 